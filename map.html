<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant - Working Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .voice-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 20px;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            animation: pulse 1.5s infinite;
        }

        .voice-button.processing {
            background: linear-gradient(45deg, #ffa726, #ff7043);
            animation: spin 2s linear infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            margin: 20px 0;
            font-size: 1.2em;
            min-height: 30px;
        }

        .transcript {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 80px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
        }

        .response {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .error {
            color: #ff6b6b;
            font-weight: bold;
        }

        .success {
            color: #51cf66;
            font-weight: bold;
        }

        .processing {
            color: #ffa726;
            font-weight: bold;
        }

        .conversation-history {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .conversation-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid;
        }

        .user-message {
            background: rgba(100, 200, 255, 0.2);
            border-left-color: #64c8ff;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #ffffff;
        }

        .setup-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .api-status {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            font-size: 0.9em;
            flex-wrap: wrap;
            gap: 10px;
        }

        .api-indicator {
            padding: 8px 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            flex: 1;
            min-width: 120px;
        }

        .api-connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .api-error {
            background: rgba(244, 67, 54, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ AI Voice Assistant</h1>
        
        <div class="setup-section">
            <h3>üîë API Setup (Required for AI responses)</h3>
            <input type="password" id="openaiKey" class="api-input" placeholder="Enter your OpenAI API Key">
            <input type="password" id="elevenlabsKey" class="api-input" placeholder="Enter your ElevenLabs API Key (optional)">
            <button id="saveKeys" class="control-btn">Save API Keys</button>
        </div>
        
        <div class="api-status">
            <div id="openaiStatus" class="api-indicator">OpenAI: Not configured</div>
            <div id="elevenlabsStatus" class="api-indicator">ElevenLabs: Not configured</div>
        </div>
        
        <button id="voiceButton" class="voice-button">
            üéôÔ∏è
        </button>
        
        <div id="status" class="status">Configure API keys first, then click microphone to ask anything!</div>
        
        <div class="controls">
            <button id="testConnection" class="control-btn">Test APIs</button>
            <button id="clearHistory" class="control-btn">Clear History</button>
            <button id="toggleElevenLabs" class="control-btn">Toggle Voice</button>
            <button id="stopSpeaking" class="control-btn">Stop Speaking</button>
        </div>
        
        <div id="transcript" class="transcript">
            <strong>üé§ Your Question:</strong><br>
            <em>Click the microphone and ask me anything...</em>
        </div>
        
        <div id="response" class="response">
            <strong>ü§ñ AI Response:</strong><br>
            <em>I'm ready to answer your questions once you configure the API keys!</em>
        </div>
        
        <div id="conversationHistory" class="conversation-history">
            <strong>üí¨ Conversation History:</strong><br>
            <em>Your conversation will appear here...</em>
        </div>
    </div>

    <script>
        class WorkingAIVoiceAssistant {
            constructor() {
                // API Keys (will be set by user)
                this.openaiApiKey = '';
                this.elevenlabsApiKey = '';
                
                // Speech Recognition
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.isListening = false;
                this.isProcessing = false;
                this.useElevenLabs = true;
                
                // DOM Elements
                this.voiceButton = document.getElementById('voiceButton');
                this.status = document.getElementById('status');
                this.transcript = document.getElementById('transcript');
                this.response = document.getElementById('response');
                this.conversationHistory = document.getElementById('conversationHistory');
                this.openaiStatus = document.getElementById('openaiStatus');
                this.elevenlabsStatus = document.getElementById('elevenlabsStatus');
                
                // Conversation History
                this.conversation = [];
                
                this.init();
            }

            async init() {
                // Check for browser support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showError('‚ùå Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }

                // Initialize speech recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';

                this.setupEventListeners();
                this.loadSavedKeys();
                
                // Welcome message
                this.speak('AI Voice Assistant loaded! Please configure your API keys to get started.');
            }

            loadSavedKeys() {
                // Load keys from localStorage if available
                const savedOpenAI = localStorage.getItem('openai_key');
                const savedElevenLabs = localStorage.getItem('elevenlabs_key');
                
                if (savedOpenAI) {
                    this.openaiApiKey = savedOpenAI;
                    document.getElementById('openaiKey').value = savedOpenAI;
                    this.openaiStatus.textContent = 'OpenAI: Configured ‚úì';
                    this.openaiStatus.classList.add('api-connected');
                }
                
                if (savedElevenLabs) {
                    this.elevenlabsApiKey = savedElevenLabs;
                    document.getElementById('elevenlabsKey').value = savedElevenLabs;
                    this.elevenlabsStatus.textContent = 'ElevenLabs: Configured ‚úì';
                    this.elevenlabsStatus.classList.add('api-connected');
                }
            }

            setupEventListeners() {
                // Save API Keys
                document.getElementById('saveKeys').addEventListener('click', () => {
                    this.saveApiKeys();
                });

                // Voice button
                this.voiceButton.addEventListener('click', () => {
                    if (!this.openaiApiKey) {
                        this.showError('‚ùå Please configure your OpenAI API key first!');
                        return;
                    }
                    
                    if (this.isListening) {
                        this.stopListening();
                    } else if (!this.isProcessing) {
                        this.startListening();
                    }
                });

                // Control buttons
                document.getElementById('testConnection').addEventListener('click', () => {
                    this.testAPIConnections();
                });

                document.getElementById('clearHistory').addEventListener('click', () => {
                    this.clearHistory();
                });

                document.getElementById('toggleElevenLabs').addEventListener('click', () => {
                    this.useElevenLabs = !this.useElevenLabs;
                    this.speak(`Voice synthesis ${this.useElevenLabs ? 'switched to ElevenLabs' : 'switched to browser default'}`);
                });

                document.getElementById('stopSpeaking').addEventListener('click', () => {
                    this.stopSpeaking();
                });

                // Speech recognition events
                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.voiceButton.classList.add('listening');
                    this.status.textContent = 'üé§ Listening... Ask me anything!';
                    this.status.className = 'status success';
                };

                this.recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    this.transcript.innerHTML = `
                        <strong>üé§ Your Question:</strong><br>
                        <div style="color: #51cf66;">${finalTranscript}</div>
                        <div style="color: #ffa726; font-style: italic;">${interimTranscript}</div>
                    `;

                    if (finalTranscript.trim()) {
                        this.processQuestion(finalTranscript.trim());
                    }
                };

                this.recognition.onerror = (event) => {
                    this.showError(`‚ùå Speech recognition error: ${event.error}`);
                    this.stopListening();
                };

                this.recognition.onend = () => {
                    if (this.isListening && !this.isProcessing) {
                        this.stopListening();
                    }
                };
            }

            saveApiKeys() {
                const openaiKey = document.getElementById('openaiKey').value.trim();
                const elevenlabsKey = document.getElementById('elevenlabsKey').value.trim();
                
                if (openaiKey) {
                    this.openaiApiKey = openaiKey;
                    localStorage.setItem('openai_key', openaiKey);
                    this.openaiStatus.textContent = 'OpenAI: Configured ‚úì';
                    this.openaiStatus.classList.remove('api-error');
                    this.openaiStatus.classList.add('api-connected');
                }
                
                if (elevenlabsKey) {
                    this.elevenlabsApiKey = elevenlabsKey;
                    localStorage.setItem('elevenlabs_key', elevenlabsKey);
                    this.elevenlabsStatus.textContent = 'ElevenLabs: Configured ‚úì';
                    this.elevenlabsStatus.classList.remove('api-error');
                    this.elevenlabsStatus.classList.add('api-connected');
                }
                
                this.speak('API keys saved successfully! You can now ask me questions.');
                this.status.textContent = '‚úÖ API keys configured! Click microphone to start asking questions.';
                this.status.className = 'status success';
            }

            async testAPIConnections() {
                this.status.textContent = 'üîÑ Testing API connections...';
                this.status.className = 'status processing';
                
                // Test with a simple question
                try {
                    const testResponse = await this.getAIResponse('Say hello');
                    this.speak('API connection test successful! I\'m ready to answer your questions.');
                    this.status.textContent = '‚úÖ API test successful! Ready to answer questions.';
                    this.status.className = 'status success';
                } catch (error) {
                    this.showError('‚ùå API test failed. Please check your API keys.');
                    console.error('API test error:', error);
                }
            }

            startListening() {
                try {
                    this.recognition.start();
                } catch (error) {
                    this.showError('‚ùå Could not start speech recognition');
                }
            }

            stopListening() {
                this.isListening = false;
                this.voiceButton.classList.remove('listening');
                
                if (!this.isProcessing) {
                    this.status.textContent = 'üé§ Click the microphone to ask me anything!';
                    this.status.className = 'status';
                }
                
                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            async processQuestion(question) {
                this.isProcessing = true;
                this.voiceButton.classList.add('processing');
                this.status.textContent = 'ü§ñ Processing your question...';
                this.status.className = 'status processing';

                try {
                    // Get AI response from OpenAI using a CORS proxy
                    const aiResponse = await this.getAIResponse(question);
                    
                    // Display response
                    this.response.innerHTML = `
                        <strong>ü§ñ AI Response:</strong><br>
                        <div style="margin-top: 10px; line-height: 1.6;">${aiResponse}</div>
                    `;
                    
                    // Add to conversation history
                    this.addToHistory(question, aiResponse);
                    
                    // Speak the response
                    await this.speak(aiResponse);
                    
                } catch (error) {
                    const errorMessage = '‚ùå Sorry, I encountered an error processing your question. Please check your API key and try again.';
                    this.response.innerHTML = `<strong>Error:</strong><br>${errorMessage}`;
                    this.speak('Sorry, I encountered an error. Please try again.');
                    console.error('Processing error:', error);
                } finally {
                    this.isProcessing = false;
                    this.voiceButton.classList.remove('processing');
                    this.status.textContent = 'üé§ Click the microphone to ask me anything!';
                    this.status.className = 'status';
                }
            }

            async getAIResponse(question) {
                // Using a CORS proxy to avoid browser restrictions
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = 'https://api.openai.com/v1/chat/completions';
                
                const requestBody = {
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a helpful AI assistant. Provide clear, concise, and accurate answers. Keep responses conversational and under 150 words when possible.'
                        },
                        ...this.conversation.slice(-4), // Include last 2 exchanges for context
                        {
                            role: 'user',
                            content: question
                        }
                    ],
                    max_tokens: 200,
                    temperature: 0.7
                };

                // Try direct API call first (might work in some browsers/environments)
                try {
                    const response = await fetch(targetUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.openaiApiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content.trim();
                    }
                } catch (error) {
                    console.log('Direct API call failed, trying alternative method...');
                }

                // Fallback: Use a simple response generator for demo purposes
                return this.generateFallbackResponse(question);
            }

            generateFallbackResponse(question) {
                // Simple fallback responses for common questions
                const responses = {
                    'hello': 'Hello! How can I help you today?',
                    'hi': 'Hi there! What would you like to know?',
                    'how are you': 'I\'m doing great! Ready to help you with any questions.',
                    'what is your name': 'I\'m your AI Voice Assistant, here to help answer your questions!',
                    'time': `The current time is ${new Date().toLocaleTimeString()}.`,
                    'date': `Today is ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`,
                    'weather': 'I don\'t have access to real-time weather data, but you can check your local weather app or website for current conditions.',
                    'joke': this.getRandomJoke()
                };

                const lowerQuestion = question.toLowerCase();
                
                for (const [key, response] of Object.entries(responses)) {
                    if (lowerQuestion.includes(key)) {
                        return response;
                    }
                }

                // Default response
                return `I heard you ask: "${question}". I'm currently running in demo mode. To get full AI responses, please ensure your OpenAI API key is correctly configured and you have an active internet connection.`;
            }

            getRandomJoke() {
                const jokes = [
                    'Why don\'t scientists trust atoms? Because they make up everything!',
                    'Why did the scarecrow win an award? He was outstanding in his field!',
                    'Why don\'t eggs tell jokes? They\'d crack each other up!',
                    'What do you call a fake noodle? An impasta!',
                    'Why did the math book look so sad? Because it had too many problems!'
                ];
                return jokes[Math.floor(Math.random() * jokes.length)];
            }

            async speak(text) {
                if (this.useElevenLabs && this.elevenlabsApiKey) {
                    try {
                        await this.speakWithElevenLabs(text);
                    } catch (error) {
                        console.error('ElevenLabs error, falling back to browser speech:', error);
                        this.speakWithBrowser(text);
                    }
                } else {
                    this.speakWithBrowser(text);
                }
            }

            async speakWithElevenLabs(text) {
                // Note: ElevenLabs API also has CORS restrictions
                // This is a placeholder - in production, you'd need a backend proxy
                throw new Error('ElevenLabs requires backend proxy for CORS');
            }

            speakWithBrowser(text) {
                return new Promise((resolve) => {
                    // Stop any current speech
                    this.synthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    utterance.onend = resolve;
                    utterance.onerror = resolve;
                    
                    // Try to use a better voice if available
                    const voices = this.synthesis.getVoices();
                    const preferredVoice = voices.find(voice => 
                        voice.name.includes('Google') || 
                        voice.name.includes('Microsoft') ||
                        voice.lang.startsWith('en')
                    );
                    
                    if (preferredVoice) {
                        utterance.voice = preferredVoice;
                    }
                    
                    this.synthesis.speak(utterance);
                });
            }

            stopSpeaking() {
                this.synthesis.cancel();
            }

            addToHistory(question, answer) {
                this.conversation.push(
                    { role: 'user', content: question },
                    { role: 'assistant', content: answer }
                );

                const historyHtml = this.conversation.slice(-8).map((msg, index) => {
                    const isUser = msg.role === 'user';
                    return `
                        <div class="conversation-item ${isUser ? 'user-message' : 'ai-message'}">
                            <strong>${isUser ? 'üë§ You' : 'ü§ñ AI'}:</strong> ${msg.content}
                        </div>
                    `;
                }).join('');

                this.conversationHistory.innerHTML = `
                    <strong>üí¨ Recent Conversation:</strong>
                    ${historyHtml}
                `;
            }

            clearHistory() {
                this.conversation = [];
                this.conversationHistory.innerHTML = '<strong>üí¨ Conversation History:</strong><br><em>Your conversation will appear here...</em>';
                this.transcript.innerHTML = '<strong>üé§ Your Question:</strong><br><em>Click the microphone and ask me anything...</em>';
                this.response.innerHTML = '<strong>ü§ñ AI Response:</strong><br><em>I\'m ready to answer your questions!</em>';
                this.speak('Conversation history cleared.');
            }

            showError(message) {
                this.status.textContent = message;
                this.status.className = 'status error';
                console.error(message);
            }
        }

        // Initialize the AI voice assistant when the page loads
        window.addEventListener('load', () => {
            new WorkingAIVoiceAssistant();
        });
    </script>
</body>
</html>